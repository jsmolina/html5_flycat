<html>
    <head>
        <title>Pacman volador</title>
        <style type="text/css" >
            #canvas {
                width: 100%;             
                border:1px solid #000;
            }
        </style>
    </head>
    <body style="margin: 0; padding: 0; background-color: 2b64b3">
    <canvas id="canvas" width="1000" height="600"></canvas>
    <div>2 POINTS</div>
    <script type="text/javascript">
        var World = function (idCanvas) {
            var idCanvas = idCanvas;
            var ctx = null;
            var canvasTemp = document.createElement("canvas");
            var spriteImg = new Image();
            var spriteEnemy1Img = new Image();
            var scrollImg = new Image();
            var spritePillImg = new Image();
            var spritePointImg = new Image();
            var tempContext = canvasTemp.getContext("2d");
            var imgWidth = 0;
            var imgHeight = 0;
            var imageData = {};
            var canvasWidth = 1000;
            var canvasHeight = 400;
            var scrollVal = 0;
            var spriteLoaded = false;
            var pillLoaded = false;
            var spriteWidth = 0;
            var spriteHeight = 0;
            var enemyWidth = 0;
            var enemyHeight = 0;
            var pillWidth = 0;
            var pillHeight = 0;   // 40X 10Y
            var pillPosX = [5, 15, 25, 35]
            var pillPosY = [2, 4, 6, 8];
            var pillCases = [true, false, false, false]
            var speed = 2;
            var rtl_counter = 0;
            var pill_counter = 39;
            var counter = 0;
            var heroPosX = 0;
            var heroPosY = 5;
            var enemyPosX = 30;
            var enemyPosY = 5;
            var jumpsX = 0;
            var jumpsY = 0;
            var inst = this;
            var score = 0;


            this.construct = function() {
                ctx = this.loadCanvas(idCanvas);  
                scrollImg.src = "images/sky1.png";
                spriteImg.src = "images/pacman.png";
                spriteEnemy1Img.src = "images/enemy1.png";
                spritePillImg.src = "images/pill.png";
                spritePointImg.src = "images/point.png";
                spriteEnemy1Img.src = "images/enemy1.png";
                scrollImg.onload = this.loadImage;
                spriteImg.onload = this.loadSprite;
                spriteEnemy1Img.onload = this.loadEnemy1;
                spritePillImg.onload = this.loadPill;
                spritePointImg.onload = this.loadPill;

            }

            this.loadCanvas = function (idCanvas) {
                var elemento = document.getElementById(idCanvas);


                if (elemento && elemento.getContext) {
                    var ctx = elemento.getContext('2d');
                    if (ctx) {
                        canvasWidth = ctx.canvas.width;
                        canvasHeight = ctx.canvas.height;
                        jumpsX = Math.round(canvasWidth / 40);
                        jumpsY = Math.round(canvasHeight / 10);
                        
                        return ctx;
                    }
                }
                return false;
            };

            this.heroLeft = function () {
                heroPosX -= 1;

                if (heroPosX < 0) {
                    heroPosX = 0;
                }
            };

            this.heroRight = function () {
                heroPosX += 1;

                if (heroPosX > 40) {
                    heroPosX = 40;
                }
            };

            this.heroUp = function () {                
                heroPosY -= 1;

                if (heroPosY < 0) {
                    heroPosY = 0;
                }
            };

            this.heroDown = function () {                
                heroPosY += 1;

                if (heroPosY > 10) {
                    heroPosY = 10;
                }
            };

            this.loadImage = function () {
                imgWidth = scrollImg.width,
                imgHeight = scrollImg.height;
                canvasTemp.width = imgWidth;
                canvasTemp.height = imgHeight;
                inst.render();
            };

            this.loadSprite = function () {
                spriteLoaded = true;
                spriteWidth = spriteImg.width,
                spriteHeight = spriteImg.height;
            };
            this.loadEnemy1 = function () {
                enemyWidth = spriteEnemy1Img.width,
                enemyHeight = spriteEnemy1Img.height;
            };

            this.loadPill = function () {
                pillWidth = spritePillImg.width,
                pillHeight = spritePillImg.height;
                pillLoaded = true;
            };

            this.render = function() {
                
                ctx.clearRect(0, 0, canvasWidth, canvasHeight);

                if (scrollVal >= canvasWidth) {
                    console.log(scrollVal);
                    scrollVal = 0;
                }

                scrollVal += speed;

                // To go the other way instead
                ctx.drawImage(scrollImg, -scrollVal, 0, imgWidth, imgHeight);
                ctx.drawImage(scrollImg, canvasWidth - scrollVal, 0, imgWidth, imgHeight);
                if (spriteLoaded) {
                    ctx.drawImage(spriteImg, 64 * counter, 0, 64, 64, heroPosX * jumpsX, heroPosY * jumpsY, 64, 64);
                    ctx.drawImage(spriteEnemy1Img, 64 * counter, 0, 64, 64, enemyPosX * jumpsX, enemyPosY * jumpsY, 64, 64);
                }

                if (pillLoaded) {
                    if (rtl_counter % 10 == 0) {
                        pill_counter = pill_counter - 1;
                        if (pill_counter < 0) {
                            pill_counter = 39;
                        }
                    }
                    for(var i = 0; i < pillCases.length; i += 1) { // for (specialPill in pillCases) {
                        var specialPill = (Math.random() *4 >= 2);
                        var currPillPosX = pillPosX[i];
                        var currPillPosY = pillPosY[i];

                        if (specialPill) {
                            ctx.drawImage(spritePillImg, 0, 0, 64, 64, pill_counter * jumpsX, currPillPosY * jumpsY, 16, 16);
                           // ctx.drawImage(spritePillImg, 0, 0, 64, 64, currPillPosX * jumpsX, pillPosY * jumpsY, 64, 64);
                        } else {
                            ctx.drawImage(spritePointImg, 0, 0, 64, 64, pill_counter * jumpsX, currPillPosY * jumpsY, 16, 16);
                        }
                    }
                }
                

                rtl_counter++;
                if (rtl_counter % 10 == 0) {
                    counter++;
                    rtl_counter = 0;
                }

                if (counter > 4) {
                    counter = 0;
                }
                setTimeout(function () {
                    inst.render();
                }, 10);
            };

            this.keyDown = function (event) {
                event = event || window.event;
                var e = event.keyCode;
                
                if (e==38 /*up*/){
                    this.heroUp();
                } else if(e == 40 /*down*/) {
                    this.heroDown();
                    //ship.accelerate(-partsX * 0.5, 0);
                } else if (e == 37 /*left*/) {
                    this.heroLeft();
                    //ship.accelerate(partsX * 0.5, 0);
                } else if (e == 39 /*right*/) {
                    this.heroRight();
                }
            }

        }

        function start() {
            world = new World("canvas");
            world.construct();
            world.render();
        }

        window.onload = function () {
            start();
        }


        document.onkeydown = function(event) {
            world.keyDown(event);
        }
    </script>
</body>
</html>